<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Cropper</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/cropper/cropper.min.css">
    <link rel="stylesheet" href="/css/dialog.css">
    <style>
        .img-preview {
            float: left;
            margin-bottom: .5rem;
            margin-right: .5rem;
            overflow: hidden;
        }
    
        .img-preview>img {
            max-width: 100%;
        }
    
        .preview-lg {
            height: 9rem;
            width: 16rem;
        }
    
        .preview-md {
            height: 4.5rem;
            width: 8rem;
        }
    
        .preview-sm {
            height: 2.25rem;
            width: 4rem;
        }
    </style>
</head>
<body>
    <div id="head-menu"></div>

    <div class="container">
        <h1>Cropper</h1>
        <img src="" id="imgView" alt="">
        <input type="file" id="fileSelect"/>
    </div>

    <div class="dialog hide" id="dlgWorkImage">
        <div class="header">
            <div class="title">
                Додати нового коритувача
            </div>
            <div class="btn-close dlgClose">
                &times;
            </div>
        </div>
        <div class="content">
            <div class="row">
                <div class="col-md-9 col-sm-9 col-xs-8">
                    <div>
                        <canvas id="canvas" style="height: 400px;">
                            Your browser does not support HTML5 Canvas
                        </canvas>
                    </div>
                </div>
                <div class="col-md-3  col-sm-3 col-xs-4">
                    <div class="docs-preview clearfix">
                        <div class="img-preview" style="width: 100%; height: 350px; border-radius: 50%;">
    
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <hr />
            <button id="saveCropImage" class="btn btn-success">Обрізати</button>
            <a href="#" class="dlgClose btn btn-danger">Скасувати</a>
        </div>
    </div>

    <script src="/js/jquery-3.4.1.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/cropper/cropper.min.js"></script>

    <script>
        $(function(){
            const file=$("#fileSelect");
            const dlgWI=$("#dlgWorkImage");

            $(dlgWI).on("click", ".dlgClose", function () {
                dlgWI.hide();
            });

            let $canvas=$("#canvas"),
                context=$canvas.get(0).getContext('2d');
            let minWidth=200;
            let isCropped=false;

            $("#saveCropImage").on('click', function (e) {
                e.preventDefault();
                var cropedImage = $canvas.cropper('getCroppedCanvas').toDataURL('image/jpg');
                console.log('------data server------', cropedImage);
                $("#imageView").attr('src', cropedImage);
                
                $(".dlgClose").click();
                isCropped = false;
            });

            file.on("change",function(){
                const flSelect=this.files;
                if(flSelect&&flSelect[0]){
                    console.log("file select",flSelect[0]);
                    if(flSelect[0].type.match(/^image\//)){
                        let rdr=new FileReader();
                        rdr.onload=function(e){

                            let img=new Image();
                            img.onload = function () {
                                if (img.width <= minWidth || img.height <= minWidth) {
                                    alert("Обрати зображення більше 700px");
                                    return;
                                }
                                dlgWI.show();
                                isCropped = true;
                                context.canvas.width = img.width;
                                context.canvas.height = img.height;
                                context.drawImage(img, 0, 0);
                                $canvas.cropper('destroy').cropper({
                                    aspectRatio: 1 / 1,
                                    viewMode: 1,
                                    dragMode: 'move',
                                    preview: '.img-preview',
                                    crop: function (e) {
                                        var data = e.detail;
                                        //var h = Math.round(data.height);
                                        var w = Math.round(data.width);
                                        if (w <= minWidth && isCropped) {
                                            this.cropper.setData({ width: minWidth });
                                        }
                                    }
                                });
                            }
                            img.src=e.target.result;
                            $("#imgView").attr('src',e.target.result);
                        }
                        rdr.readAsDataURL(flSelect[0]);
                    }else{
                        alert("Select image");
                    }
                }else{
                    alert("Select file");
                }
            });
        })
    </script>
</body>
</html>